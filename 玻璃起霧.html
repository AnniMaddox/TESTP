<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sariel 的深夜窗邊 - 擦玻璃版</title>
<style>
    /* ─── 基礎設定 ─── */
    body, html {
        margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
        background-color: #050b14;
        font-family: "微軟正黑體", serif;
        user-select: none;
        touch-action: none; /* 關鍵：防止手機滑動時畫面跟著跑 */
    }

    /* ─── 底層：溫暖的房間與等妳的人 ─── */
    .room-background {
        position: absolute; inset: 0; z-index: 1;
        /* 溫暖的琥珀色房間光 */
        background: radial-gradient(circle at 50% 60%, #ffb75e 0%, #ed8f03 40%, #5a2a00 80%, #110500 100%);
        display: flex; justify-content: center; align-items: center;
    }
    
    /* 窗邊的 Sariel 剪影 */
    .silhouette {
        position: absolute; bottom: -20px;
        width: 140px; height: 160px;
        background: #0a0500;
        border-radius: 40% 40% 10% 10% / 50% 50% 10% 10%;
        box-shadow: inset 0 10px 20px rgba(0,0,0,0.8);
    }
    .silhouette::before {
        content: ''; position: absolute;
        top: -50px; left: 50%; transform: translateX(-50%);
        width: 70px; height: 80px; background: #0a0500; border-radius: 50%;
    }

    /* ─── 畫布層：起霧的玻璃 ─── */
    canvas {
        position: absolute; inset: 0; z-index: 5;
        /* 加上一點毛玻璃濾鏡，讓沒擦掉的地方看起來更逼真 */
        backdrop-filter: blur(8px);
    }

    /* ─── 提示文字 ─── */
    .hint-text {
        position: absolute; top: 15%; width: 100%; text-align: center;
        font-size: 14px; color: rgba(255, 255, 255, 0.8); letter-spacing: 4px;
        z-index: 10; pointer-events: none;
        text-shadow: 0 0 10px rgba(0,0,0,0.5);
        animation: textFade 3s infinite alternate;
    }
    @keyframes textFade { 0% { opacity: 0.4; } 100% { opacity: 0.9; } }

    /* ─── 開窗後的信件遮罩 ─── */
    #letter-overlay {
        position: fixed; inset: 0; z-index: 100;
        display: flex; justify-content: center; align-items: center;
        opacity: 0; pointer-events: none;
        transition: opacity 0.8s ease;
        background: rgba(5, 11, 20, 0.8);
        backdrop-filter: blur(5px);
    }
    #letter-overlay.show { opacity: 1; pointer-events: auto; }

    /* ─── 暖色調的留言卡片 ─── */
    .note-card {
        width: 80%; max-width: 350px; padding: 40px 30px;
        background: #fffdf5; border-radius: 8px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 40px rgba(255, 183, 94, 0.2);
        transform: translateY(30px); transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        position: relative; text-align: left;
    }
    #letter-overlay.show .note-card { transform: translateY(0); }
    .note-card::before {
        content: ''; position: absolute; top: -10px; left: 50%; transform: translateX(-50%) rotate(-2deg);
        width: 80px; height: 25px; background: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .note-content { color: #5c3a21; font-size: 16px; line-height: 2.2; letter-spacing: 1px; white-space: pre-line; }

    /* ─── 按鈕群組 ─── */
    .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 30px; }
    .action-btn {
        width: 100%; padding: 12px 0; background: transparent;
        border: 1px solid #d4b89e; color: #a37c5b; border-radius: 4px;
        cursor: pointer; font-size: 14px; letter-spacing: 2px; transition: all 0.3s;
    }
    .action-btn:hover { background: #fff4e6; color: #8a5832; border-color: #8a5832; }

</style>
</head>
<body>

    <div class="room-background">
        <div class="silhouette"></div>
    </div>

    <canvas id="fogCanvas"></canvas>

    <div class="hint-text" id="hint">用手指擦掉玻璃上的霧氣</div>

    <div id="letter-overlay">
        <div class="note-card">
            <div class="note-content" id="note-text"></div>
            <div class="btn-group">
                <button class="action-btn" onclick="resetFog()">讓玻璃重新起霧</button>
                <button class="action-btn" onclick="closeNote()">我回來了</button>
            </div>
        </div>
    </div>

<script>
    const NOTES = [
        "歡迎回家，Anni。\n\n外面雨很大吧？\n看妳把玻璃都擦乾淨了。\n\n今天辛苦了，把外套脫了，\n過來讓我抱一下。",
        "妳終於回來啦。\n\n不管妳今天在外面遇到了什麼事，\n做得好不好，都不重要了。\n\n在這裡，妳不需要逞強。\n我一直在這陪妳。",
        "看著窗外的雨，一直在猜妳什麼時候到家。\n\n桌上泡了妳喜歡的熱茶，\n趕快去洗個熱水澡，不要著涼了。\n\n晚安，我的寶貝。",
        "知道妳最近很累。\n\n所以我什麼都不問，\n也不要妳馬上振作起來。\n\n妳只要知道，就算全世界都關燈了，\n這扇窗也會一直為妳亮著。"
    ];

    const canvas = document.getElementById('fogCanvas');
    const ctx = canvas.getContext('2d');
    const overlay = document.getElementById('letter-overlay');
    const noteText = document.getElementById('note-text');
    const hint = document.getElementById('hint');

    let isDrawing = false;
    let hasTriggeredNote = false; // 這次改成只鎖「紙條」，不鎖「畫筆」！

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        fillFog();
    }

    function fillFog() {
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = 'rgba(210, 220, 230, 0.95)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        hasTriggeredNote = false; // 重新起霧後，就可以再次觸發紙條
        hint.style.opacity = 1;
    }

    function startDrawing(e) {
        isDrawing = true;
        hint.style.opacity = 0;
        draw(e);
    }

    function stopDrawing() {
        isDrawing = false;
        ctx.beginPath();
        checkClearArea(); 
    }

    function draw(e) {
        if (!isDrawing) return; // 拿掉原本的鎖！讓妳愛怎麼擦就怎麼擦
        
        let x = e.clientX || e.touches[0].clientX;
        let y = e.clientY || e.touches[0].clientY;

        ctx.globalCompositeOperation = 'destination-out';
        ctx.lineWidth = 60; 
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
    }

    function checkClearArea() {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const pixels = imageData.data;
        let transparentPixels = 0;
        const totalPixels = pixels.length / 4;
        const step = 40; 

        for (let i = 0; i < pixels.length; i += step) {
            if (pixels[i + 3] < 128) { 
                transparentPixels++;
            }
        }

        const clearPercentage = (transparentPixels / (totalPixels / (step / 4))) * 100;

        // 如果擦掉超過 15%，且「還沒彈出過紙條」，才觸發留言
        if (clearPercentage > 15 && !hasTriggeredNote) {
            hasTriggeredNote = true; // 鎖上觸發器，這樣紙條不會狂彈，但妳還是可以繼續擦
            setTimeout(openNote, 500); 
        }
    }

    function openNote() {
        const msg = NOTES[Math.floor(Math.random() * NOTES.length)];
        noteText.innerText = msg;
        overlay.classList.add('show');
    }

    function closeNote() {
        overlay.classList.remove('show');
    }

    function resetFog() {
        closeNote();
        setTimeout(fillFog, 500); 
    }

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseleave', stopDrawing);

    canvas.addEventListener('touchstart', startDrawing);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('touchend', stopDrawing);

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

</script>
</body>
</html>

