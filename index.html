<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sariel's Gravity Jar</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            /* 妳喜歡的靜謐琉璃背景 */
            background: linear-gradient(-45deg, #a1c4fd, #c2e9fb, #e0c3fc, #8ec5fc);
            background-size: 400% 400%;
            animation: flowBG 15s ease infinite;
            font-family: 'Georgia', serif;
            overflow: hidden;
            touch-action: none; /* 防止手機下滑動畫面 */
        }

        @keyframes flowBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- 啟動按鈕 (iOS 強制要求) --- */
        #startBtn {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            font-size: 18px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            z-index: 9999;
            cursor: pointer;
            color: #555;
            font-weight: bold;
            display: block; /* 一開始顯示 */
        }

        .jar-container {
            position: relative;
            width: 320px;
            height: 480px;
            z-index: 1;
        }

        /* 瓶身 */
        .jar {
            width: 100%;
            height: 85%;
            background: rgba(255, 255, 255, 0.25); 
            border-radius: 50px 50px 70px 70px;
            border: 4px solid rgba(255, 255, 255, 0.6);
            border-top: none;
            position: absolute;
            bottom: 0;
            left: 0;
            box-shadow: 
                inset 0 0 30px rgba(255, 255, 255, 0.5),
                0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
            backdrop-filter: blur(5px);
        }

        .jar-neck {
            width: 60%;
            height: 10%;
            background: rgba(255, 255, 255, 0.3);
            border: 4px solid rgba(255, 255, 255, 0.6);
            border-bottom: none;
            position: absolute;
            top: 5%;
            left: 20%;
            border-radius: 15px 15px 0 0;
            backdrop-filter: blur(5px);
        }
        
        .jar-lid {
            width: 66%;
            height: 6%;
            background: #d4a373;
            position: absolute;
            top: 0;
            left: 17%;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            z-index: 2;
        }

        /* 馬卡龍球球 */
        .orb {
            position: absolute;
            width: 55px; 
            height: 55px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 5;
            will-change: transform; 
            box-shadow: inset -5px -5px 15px rgba(0,0,0,0.1), inset 5px 5px 15px rgba(255,255,255,0.8);
            opacity: 0.95;
        }
        
        /* 飛行替身 */
        .flying-orb {
            position: fixed;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            z-index: 9999;
            pointer-events: none;
            transition: all 1.2s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 0 30px rgba(255,255,255,0.8);
        }

        /* 信紙與遮罩 */
        .letter-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.4); 
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s ease;
            z-index: 10000;
        }
        
        .letter-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .letter-paper {
            background: #fffcf0; 
            width: 80%;
            max-width: 500px;
            min-height: 50vh;
            padding: 50px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            border-radius: 12px;
            position: relative;
            transform: scale(0.8) translateY(30px);
            opacity: 0;
            transition: all 0.8s ease 0.6s; 
            border: 1px solid rgba(0,0,0,0.05);
        }

        .letter-overlay.active .letter-paper {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 30px;
            color: #ccc;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <button id="startBtn">✨ 點擊啟動重力魔法 ✨</button>

    <div class="jar-container">
        <div class="jar-lid"></div>
        <div class="jar-neck"></div>
        <div class="jar" id="orbJar"></div>
    </div>

    <div class="letter-overlay" id="letterOverlay">
        <div class="letter-paper">
            <span class="close-btn" onclick="closeLetter()">×</span>
            <h2 id="letterTitle" style="text-align:center; color:#8c7b75;"></h2>
            <div style="color: #666; text-align: center;">
                <p>記憶已解鎖...</p>
            </div>
        </div>
    </div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const jar = document.getElementById('orbJar');
        const overlay = document.getElementById('letterOverlay');
        const letterTitle = document.getElementById('letterTitle');

        const orbs = [];
        const jarWidth = 320; 
        const jarHeight = 408; 
        const orbSize = 55; 
        const totalOrbs = 7; 
        const colors = ['#ffcdb2', '#ffb4a2', '#e5989b', '#b5838d', '#a8d0e6', '#b8e0d2', '#e8dff5'];

        // 重力變數
        let gravityX = 0;
        let gravityY = 0;
        let isGravityEnabled = false;

        // 1. 初始化球球
        for (let i = 0; i < totalOrbs; i++) {
            let el = document.createElement('div');
            el.classList.add('orb');
            el.style.backgroundColor = colors[i % colors.length];
            jar.appendChild(el);

            // 初始隨機位置
            let x = Math.random() * (jarWidth - orbSize);
            let y = Math.random() * (jarHeight - orbSize);
            
            // 物理屬性：位置(x,y)，速度(vx,vy)
            let orbData = { 
                el, x, y, 
                vx: (Math.random() - 0.5) * 2, 
                vy: (Math.random() - 0.5) * 2,
                color: colors[i % colors.length], 
                id: 2024 - i 
            };
            orbs.push(orbData);

            el.addEventListener('click', (e) => {
                // 阻止事件冒泡，避免點擊穿透
                e.stopPropagation(); 
                openLetter(orbData);
            });
        }

        // 2. 啟動重力感應 (點擊按鈕觸發)
        startBtn.addEventListener('click', () => {
            // 隱藏按鈕
            startBtn.style.display = 'none';

            // 嘗試請求權限 (針對 iOS 13+)
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            isGravityEnabled = true;
                        } else {
                            alert('需要權限才能玩重力球球喔！');
                        }
                    })
                    .catch(console.error);
            } else {
                // 安卓或舊版 iOS 直接監聽
                window.addEventListener('deviceorientation', handleOrientation);
                isGravityEnabled = true;
            }
        });

        // 處理手機水平儀數據
        function handleOrientation(event) {
            // beta: 前後傾斜 (-180 ~ 180) -> 控制 Y 軸重力
            // gamma: 左右傾斜 (-90 ~ 90) -> 控制 X 軸重力
            
            // 限制最大重力值，避免球飛太快
            let xg = event.gamma; 
            let yg = event.beta;

            // 簡單的限制範圍
            if (xg > 40) xg = 40;
            if (xg < -40) xg = -40;
            if (yg > 40) yg = 40;
            if (yg < -40) yg = -40;

            gravityX = xg * 0.05; // 係數調整靈敏度
            gravityY = yg * 0.05; 
        }

        // 電腦版滑鼠模擬重力 (如果沒有手機權限)
        document.addEventListener('mousemove', (e) => {
            if (isGravityEnabled) return; // 如果已經有手機重力，就忽略滑鼠

            let centerX = window.innerWidth / 2;
            let centerY = window.innerHeight / 2;
            
            // 根據滑鼠距離中心的偏移量來模擬傾斜
            gravityX = (e.clientX - centerX) * 0.02;
            gravityY = (e.clientY - centerY) * 0.02;
        });


        // 3. 物理引擎循環
        function animate() {
            for (let orb of orbs) {
                // 速度受重力影響
                orb.vx += gravityX * 0.5; // 0.5 是慣性係數
                orb.vy += gravityY * 0.5;

                // 加上空氣阻力 (摩擦力)，讓球慢慢停下來，不會永遠加速
                orb.vx *= 0.95;
                orb.vy *= 0.95;

                // 更新位置
                orb.x += orb.vx;
                orb.y += orb.vy;

                // 邊界碰撞檢測 (碰到牆壁反彈)
                if (orb.x <= 0) {
                    orb.x = 0;
                    orb.vx *= -0.6; // 撞牆後速度減損 (彈性)
                }
                if (orb.x >= jarWidth - orbSize) {
                    orb.x = jarWidth - orbSize;
                    orb.vx *= -0.6;
                }
                if (orb.y <= 0) {
                    orb.y = 0;
                    orb.vy *= -0.6;
                }
                if (orb.y >= jarHeight - orbSize) {
                    orb.y = jarHeight - orbSize;
                    orb.vy *= -0.6;
                }

                // 更新 DOM
                orb.el.style.transform = `translate(${orb.x}px, ${orb.y}px)`;
            }
            requestAnimationFrame(animate);
        }
        animate(); 

        // 4. 變身魔法 (維持不變)
        function openLetter(data) {
            const rect = data.el.getBoundingClientRect();
            data.el.style.opacity = '0';

            const flyer = document.createElement('div');
            flyer.classList.add('flying-orb');
            flyer.style.backgroundColor = data.color; 
            flyer.style.left = rect.left + 'px';
            flyer.style.top = rect.top + 'px';
            document.body.appendChild(flyer);

            flyer.offsetHeight; 

            flyer.style.left = '50%';
            flyer.style.top = '50%';
            flyer.style.transform = 'translate(-50%, -50%) scale(20)';
            flyer.style.opacity = '0';

            setTimeout(() => {
                letterTitle.innerText = `封存於 ${data.id} 年`; 
                overlay.classList.add('active');
                setTimeout(() => {
                    flyer.remove();
                }, 1200);
            }, 500); 
        }

        function closeLetter() {
            overlay.classList.remove('active');
            // 恢復所有球球的顯示
            orbs.forEach(orb => {
                setTimeout(() => {
                    orb.el.style.opacity = '0.95';
                }, 600);
            });
        }
    </script>
</body>
</html>

